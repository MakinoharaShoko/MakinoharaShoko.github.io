<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/7835419622e5afa0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7835419622e5afa0.css" data-n-g=""/><link rel="preload" href="/_next/static/css/50425c9106578cba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50425c9106578cba.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-5020794388548d5e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9cd66785574873e8.js" defer=""></script><script src="/_next/static/chunks/175675d1-7de8b3bfdcedb0f1.js" defer=""></script><script src="/_next/static/chunks/9f96d65d-c9e0543547ce45e9.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-c0ab723d8d52e6df.js" defer=""></script><script src="/_next/static/6dox2F1auKbKKaUvItzUG/_buildManifest.js" defer=""></script><script src="/_next/static/6dox2F1auKbKKaUvItzUG/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="mainLayout_out__ZYqWw" style="height:calc(100vh - var(--vh-offset, 0px))"><div class="mainLayout_mainarea__QxaY0"><div class="post_post__ejhnw"><div class="post_top__JuBkM"><div class="post_b__Bj3sV"><img alt="back" src="/_next/static/media/back.f6d17d78.png" width="480" height="480" decoding="async" data-nimg="1" class="post_bi__9ghX8" loading="lazy" style="color:transparent"/></div><div class="post_tit__Xu2qi">WASM Rust 踩坑记（附完整解决方法<img alt="open" src="/_next/static/media/down.9feac32f.png" width="480" height="480" decoding="async" data-nimg="1" class="post_iconSmall__5Hxz8" loading="lazy" style="color:transparent"/></div><div class="post_b__Bj3sV"><img alt="close" src="/_next/static/media/close.315313d8.png" width="480" height="480" decoding="async" data-nimg="1" class="post_bi__9ghX8" loading="lazy" style="color:transparent"/></div></div><div class="post_mdWarpper__Brjcd"><div class="markdown-body post_md__a6C1y"><h2 id="从零开始的wasm踩坑">从零开始的WASM踩坑</h2>
<p>在这个风和日丽、阳光明媚的下午，我参照教程 <a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Rust_to_wasm">https://developer.mozilla.org/zh-CN/docs/WebAssembly/Rust_to_wasm</a> 开始编写第一个<code>WASM</code>程序。</p>
<p>由于已经配置好了 Rust 环境，所以我预期一切正常，只需要半小时就能拿下战斗。但是在安装 Wasm 环境的时候，就遇到了第一个坑：Cargo 的源是 GitHub 源，国内用不了啊。</p>
<p>不过这种换源问题怎么能难得倒我们呢？开换！</p>
<p><a href="https://mirrors.gitcode.host/zzy/rust-crate-guide/4-cargo/4.1-source-replacement.html">https://mirrors.gitcode.host/zzy/rust-crate-guide/4-cargo/4.1-source-replacement.html</a></p>
<p>换好源之后，就开始愉快地安装环节</p>
<pre><code class="language-shell">cargo install wasm-pack
</code></pre>
<p>然后就来到了喜闻乐见的报错环节</p>
<pre><code class="language-shell">error: failed to run custom build command for `openssl-sys v0.9.55`
</code></pre>
<p>于是安装 OpenSSL，并配置环境变量，然后没卵用......</p>
<p><strong>找了很多方案，最终选择直接下载编译好的安装包，简单粗暴。（如果你遇到了和我一样的问题，直接看这个</strong></p>
<blockquote>
<p>解决方案： <a href="https://stackoverflow.com/questions/68646684/cant-install-cargo-wasm-pack">https://stackoverflow.com/questions/68646684/cant-install-cargo-wasm-pack</a></p>
<p>下载地址： <a href="https://rustwasm.github.io/wasm-pack/installer/#">https://rustwasm.github.io/wasm-pack/installer/#</a></p>
</blockquote>
<p>然后就按照教程继续做，准备构建的时候发现了一个问题，<code>wasm-bindgen</code>的版本号对不上</p>
<p>改为0.2.79后解决问题。</p>
<pre><code class="language-toml">[package]
name = &quot;hello-wasm&quot;
version = &quot;0.1.0&quot;
authors = [&quot;Mahiru_@outlook.com&quot;]
description = &quot;A sample project with wasm-pack&quot;
license = &quot;MIT/Apache-2.0&quot;
repository = &quot;https://github.com/yourgithubusername/hello-wasm&quot;

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
wasm-bindgen = &quot;0.2.79&quot;
</code></pre>
<p>根据 MDN 的教程，你应该运行这个编译指令：</p>
<pre><code class="language-shell">$ wasm-pack build --scope mynpmusername
</code></pre>
<p>然后你就错了，然后遇到这个报错</p>
<pre><code>Failed to load module script: The server responded with a non-JavaScript MIME type of &quot;application/wasm&quot;. Strict MIME type checking is enforced for module scripts per HTML spec.
</code></pre>
<blockquote>
<p>参考： <a href="https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application">https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application</a></p>
</blockquote>
<p>你应该运行的是这个指令，以指定编译目标：</p>
<pre><code class="language-shell">wasm-pack build --release --target web
</code></pre>
<p><strong>你以为这就完了吗？</strong></p>
<p>接下来，当我试图在 JS 代码中引入 <code>WASM</code>的时候，发现了新的问题。</p>
<p>MDN 提供的代码是这样的：</p>
<pre><code class="language-js">const js = import(&quot;./node_modules/@yournpmusername/hello-wasm/hello_wasm.js&quot;);
js.then(js =&gt; {
  js.greet(&quot;WebAssembly&quot;);
});

</code></pre>
<p>这段代码屁有没有，然后你会收获一个报错：</p>
<pre><code>Uncaught (in promise) TypeError: Cannot read properties of undefined (reading &#x27;__wbindgen_malloc&#x27;)
</code></pre>
<p><strong>正确的代码是：</strong></p>
<pre><code class="language-js">import init from &#x27;./pkg/hello_wasm.js&#x27;;
import {greet} from &#x27;./pkg/hello_wasm.js&#x27;;

function run() {
    // use the function ex_function1 here
    greet(&#x27;123&#x27;)
}

init().then(run)
</code></pre>
<blockquote>
<p>参考： <a href="https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application">https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application</a></p>
</blockquote>
<p>然后你创建的一个 HTML 文档，并粘贴了 MDN 给的示例：</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;hello-wasm example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script src=&quot;./index.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>又错了！！！！！！</strong></p>
<pre><code>Uncaught SyntaxError: Cannot use import statement outside a module
</code></pre>
<p>不过这个问题就很简单了，加上 <code>type=&quot;module&quot;</code> 就可以了。</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;hello-wasm example&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script type=&quot;module&quot; src=&quot;./index.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>最后，你成功运行了自己的第一个用 Rust 编写的 <code>WASM</code> 代码，可喜可贺。啪啪啪啪啪啪（鼓掌</p>
<h2 id="完整的示例代码请看">完整的示例代码，请看：</h2>
<p><a href="https://github.com/MakinoharaShoko/Learning-Code/tree/main/Rust/hello-wasm">https://github.com/MakinoharaShoko/Learning-Code/tree/main/Rust/hello-wasm</a> （RUST）</p>
<p><a href="https://github.com/MakinoharaShoko/Learning-Code/tree/main/Wasm/WASM_Test_1">https://github.com/MakinoharaShoko/Learning-Code/tree/main/Wasm/WASM_Test_1</a> （WASM 网页）</p></div></div></div></div><div class="mainLayout_bottom__As9s_"><div class="mainLayout_tag__Ep3_f"><img alt="launcher" src="/_next/static/media/launcher.d8f01379.png" width="1024" height="1024" decoding="async" data-nimg="1" class="mainLayout_tagImg__qoDJq" loading="lazy" style="color:transparent"/></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":"---\nlayout:     post\ntitle:      WASM Rust 踩坑记（附完整解决方法\nintro:   \"\"\ndate:       2022-4-6 23:00:00\nauthor:     \"Mahiru\"\ncatalog: true\ntags:\n    - 工程开发\n---\n\n## 从零开始的WASM踩坑\n\n在这个风和日丽、阳光明媚的下午，我参照教程 https://developer.mozilla.org/zh-CN/docs/WebAssembly/Rust_to_wasm 开始编写第一个`WASM`程序。\n\n由于已经配置好了 Rust 环境，所以我预期一切正常，只需要半小时就能拿下战斗。但是在安装 Wasm 环境的时候，就遇到了第一个坑：Cargo 的源是 GitHub 源，国内用不了啊。\n\n不过这种换源问题怎么能难得倒我们呢？开换！\n\nhttps://mirrors.gitcode.host/zzy/rust-crate-guide/4-cargo/4.1-source-replacement.html\n\n换好源之后，就开始愉快地安装环节\n\n```shell\ncargo install wasm-pack\n```\n\n然后就来到了喜闻乐见的报错环节\n\n```shell\nerror: failed to run custom build command for `openssl-sys v0.9.55`\n```\n\n于是安装 OpenSSL，并配置环境变量，然后没卵用......\n\n**找了很多方案，最终选择直接下载编译好的安装包，简单粗暴。（如果你遇到了和我一样的问题，直接看这个**\n\n\u003e 解决方案： https://stackoverflow.com/questions/68646684/cant-install-cargo-wasm-pack\n\u003e\n\u003e 下载地址： https://rustwasm.github.io/wasm-pack/installer/# \n\n然后就按照教程继续做，准备构建的时候发现了一个问题，`wasm-bindgen`的版本号对不上\n\n改为0.2.79后解决问题。\n\n```toml\n[package]\nname = \"hello-wasm\"\nversion = \"0.1.0\"\nauthors = [\"Mahiru_@outlook.com\"]\ndescription = \"A sample project with wasm-pack\"\nlicense = \"MIT/Apache-2.0\"\nrepository = \"https://github.com/yourgithubusername/hello-wasm\"\n\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\nwasm-bindgen = \"0.2.79\"\n```\n\n根据 MDN 的教程，你应该运行这个编译指令：\n\n```shell\n$ wasm-pack build --scope mynpmusername\n```\n\n然后你就错了，然后遇到这个报错\n\n```\nFailed to load module script: The server responded with a non-JavaScript MIME type of \"application/wasm\". Strict MIME type checking is enforced for module scripts per HTML spec.\n```\n\n\u003e 参考： https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application\n\n你应该运行的是这个指令，以指定编译目标：\n\n```shell\nwasm-pack build --release --target web\n```\n\n**你以为这就完了吗？**\n\n接下来，当我试图在 JS 代码中引入 `WASM`的时候，发现了新的问题。\n\nMDN 提供的代码是这样的：\n\n```js\nconst js = import(\"./node_modules/@yournpmusername/hello-wasm/hello_wasm.js\");\njs.then(js =\u003e {\n  js.greet(\"WebAssembly\");\n});\n\n```\n\n这段代码屁有没有，然后你会收获一个报错：\n\n```\nUncaught (in promise) TypeError: Cannot read properties of undefined (reading '__wbindgen_malloc')\n```\n\n**正确的代码是：**\n\n```js\nimport init from './pkg/hello_wasm.js';\nimport {greet} from './pkg/hello_wasm.js';\n\nfunction run() {\n    // use the function ex_function1 here\n    greet('123')\n}\n\ninit().then(run)\n```\n\n\u003e 参考： https://stackoverflow.com/questions/64308461/failed-to-load-wasm-application\n\n然后你创建的一个 HTML 文档，并粘贴了 MDN 给的示例：\n\n```html\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003ctitle\u003ehello-wasm example\u003c/title\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cscript src=\"./index.js\"\u003e\u003c/script\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n**又错了！！！！！！**\n\n```\nUncaught SyntaxError: Cannot use import statement outside a module\n```\n\n不过这个问题就很简单了，加上 `type=\"module\"` 就可以了。\n\n```html\n\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003ctitle\u003ehello-wasm example\u003c/title\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cscript type=\"module\" src=\"./index.js\"\u003e\u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n```\n\n最后，你成功运行了自己的第一个用 Rust 编写的 `WASM` 代码，可喜可贺。啪啪啪啪啪啪（鼓掌\n\n## 完整的示例代码，请看：\n\nhttps://github.com/MakinoharaShoko/Learning-Code/tree/main/Rust/hello-wasm （RUST）\n\nhttps://github.com/MakinoharaShoko/Learning-Code/tree/main/Wasm/WASM_Test_1 （WASM 网页）\n"},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2022-4-6-Wasm.markdown"},"buildId":"6dox2F1auKbKKaUvItzUG","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>