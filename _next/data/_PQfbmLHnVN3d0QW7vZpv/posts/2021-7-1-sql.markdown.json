{"pageProps":{"post":"---\nlayout:     post\ntitle:      \"数据库复习\"\nintro:   \"\"\ndate:       2021-7-1 21:00:01\nauthor:     \"Makinohara\"\ncatalog: true\ntags:\n    - 计算机基础\n    \n---\n\n# SQL语句\n\n1、创建与删除\n\n```sql\n#数据库\ncreate database 数据库;\ndrop database 数据库;\n\n#表\ncreate table table1 (\n    学号 char(4) primary key,\n    姓名 char(20) not null\n)\n\n#索引\ncreate unique index idx on S(Sno DESC);#降序排列\n\n#视图\ncreate view view_name as\nselect * from s where city = 'New York';\ndrop view view_name;\n\n#角色\ncreate role role_name;\ngrant all privileges on S to role_name with grant option;\ndrop role role_name;\n\n#索引：\ncreate [unique|cluster(聚集)]index Index_name on S(Sno);\ndrop index index_name;\n```\n\n2、查询与修改\n\n```sql\n#基本查询\nselect Sno from S;\n\n#带别名\nselect Sno 学号 , Grade 成绩 , joinGroup 加入社团 from S;\n\n#带条件\nselect Sno from S where Sage > 18;\nselect Sno from S where Sage between 18 and 20;\nselect Sno from S where name not in ('Yukinoshita','Yui');\nselect Sno from S where name like 'Yukinoshita%';\nselect Sno from S where joinGroup is not null;\n\n#带排序\nselect Sno from S order by Grade DESC;\nselect top 10 Sno from S order by Grade DESC;#选择前10名的学生。\n\n#聚集\nselect avg(Grade) from S;\nselect count(*) from S;\nselect count(distinct joinGroup) from S;#相同内容只计数一次\nselect Sno from S group by Sno having count(distinct chooseClass) > 3;\n\n#连接\nselect S.* , SC.* from S,SC where S.Cno = SC.Cno;\nselect S.Sno , S.name , S.city , SPJ.qty from s , SPJ \nwhere S.Sno = SPJ.Sno and SPJ.Jno = 'J001' and SPJ.qty >300;\n\n#嵌套\nselect Sname from S where Sno in (select Sno from SC where Cno = '1001');\n\n\n```\n\n3、修改\n\n```sql\n#插入\ninsert into S values('114514','李田所','C','回家部','24');\nselect * into S from 下北泽高 where Sname like '李田所';#把信息复制到大学\n\n#修改\nupdate S set Grade = 'B' where Sno = 114514;\n\n#删除\ndelete from S where Sno = 114514;\n\n#批量\nupdate S set Sage = Sage +1 ;\n\n#带子查询\nupdate SPJ set QTY = QTY - 50 where JNO in( select JNO from J \n                                           where City = '天津');\n  \n#alter\nalter table tableName drop column columnName;#删除列\nalter table tableName add column Sbirth char(20);#添加列\nalter table tableName alter column columnname datatype# 改变数据类型\n\n#drop\ndrop table user index role ......;#drop一般删除数据结构或对象（包括属性列）\t\t，\n#而delete则倾向于删除对象中的元组。\n```\n\n\n\n4、视图\n\n```sql\n#创建\ncreate view S_BJ_VIEW as \nselect * from S where city = '北京' with check option;\n\n#删除\ndrop view ViewName;\n\n#查询\nselect Sno,Sname from S_BJ_VIEW where STAT > 'B';\nselect * from S_AVGQTY where QAVG >=300;\n\n#视图消解法：\n#定义的视图：\ncreate view S_AVGQTY(SNO,PNO,QAVG)\nas select SNO,PNO,AVG(QTY) from SPJ group by SNO,PNO;\n#查询语句：select * from S_AVGQTY where QAVG >=300;\nselect * from S_AVGQTY where QAVG >=300;\n#转换后：\nselect SNO,PNO,AVG(QTY) from SPJ group by SNO,PNO having AVG(QTY)>=300;\n\n#更新数据：\ninsert into S_BJ_VIEW value('S7','北京114514电子厂','B','北京');\n\n#删除：\ndelete from S_BJ_VIEW where SNAME = '北京114514电子厂';\n```\n\n5、安全性\n\n```sql\n#创建用户\ncreate user userName for login loginName with default_schema = schName;\ncreate login loginName with password = ..., default_database = DB_NAME;\n\n#创建角色\ncreate role RoleName; \ngrant RoleName to UserName with admin option;\n\n#权限管理\ngrant all privileges on S to Rolename/Username; #with grant option:可以传递权限\nrevoke all privileges on S from Rolename/Username;\ndeny update on S to Rolename/Username;#拒绝这一权限，使其加入其他有update权限组后仍然不能执行该操作。\n```\n\n6、完整性：\n\n```sql\n#主码定义：\ncreate table s(\n    Sno char(4) primary key;\n    ......\n)\n\ncreate table s(\n    ......\n    primary key (Sno);\n)\ncreate table s (\n\t......\n    primary key(Sno,Pno,Jno);\n)\n\n#参照完整性：\ncreate table s(\n\t......\n    foreign key (SNO) references s(SNO);\n)\n\n#其他完整性：\nnot null #非空\nunique # 唯一\ndefault 'defaultValue' #默认值\n\n#check约束\ncreate table s(\n\t......\n    STAT Char(2) check(STAT in ('A','B','C')),\n    ......\n)\n\n#constraint命令\ncreate table s (\n\t......\n    Sname char(20) constraint c1 not null # 此时c1这一完整性约束(constraint)的值为not null\n)\nalter table s drop constraint c1;\nalter table s add constraint c2 check(......);\n\n```\n\n# 数据库概念复习\n\n## 关系运算\n\n1、选择\n\n$$\\sigma(R)_F=\\{t|t \\in R\\wedge F(t) = true\\}$$\n\n2、投影\n\n$$\\Pi_A(R)=\\{t[A]|t \\in R\\}$$\n\n3、连接\n\n等值连接：选取笛卡尔级中等值的那些元组\n\n自然连接：在等值连接的基础上去掉重复的属性列\n\n4、除运算\n\nR÷S:\n\n用于选出以下内容：\n\n属性：在R不在S的属性\n\n元组：删去的属性对得上在R中的值\n\n比如：\n\nR:\n\nSno Jno\n\na      1\n\nb      2\n\nc      3\n\nS:\n\n1\n\n3\n\nR÷S:\n\nSno\n\na\n\nc\n\n**其他较为重要的运算：交并减、笛卡尔积**\n\n## 数据库安全\n\n### 自主：\n\n授予权限的类型：\n\n| 基本表、视图                                          | 属性列                                         |\n| ----------------------------------------------------- | ---------------------------------------------- |\n| select insert update delete references all privileges | select insert update references all privileges |\n\n一个简单的例子：\n\ngrant update(Sno),select on table SC to User1;\n\n对属性列：权限后面加括号，表明该权限生效的属性列\n\n可传递：with grant option;\n\n收回权限：同grant，但有需要注意的地方：\n\n最后加 cascade/restrict：是否级联操作或约束操作。\n\n角色：\n\n创建：create role rolename ;\n\n授予权限同用户\n\n将角色权限授予用户：grant Rolename to User;\n\n解除权限：revoke Rolename from User;\n\n撤销授权同用户\n\n### 强制：\n\n设定若干级别：\n\nTS>=S>=C>=P\n\n访问规则：\n\n主体许可证等级大于等于客体，可以读。\n\n主体许可证等级小于等于客体，可以写。\n\n第二条解释：高许可证主体没有办法写出一个更低等级的客体。\n\n视图：\n\ncreate view as(select......);\n\ngrant select on view to ......;\n\n## 完整性：\n\n实体完整性：\n\n```sql\ncreate table ...(\n    ......\n    Sname char(20) primary key;#在列级\n    \n    ......\n    primary key (Sname);#在表级\n    \n    primary key (Sname,Sno);#在表级，多列\n\n)\n```\n\n参照完整性：\n\n```sql\ncreate table S2(\n    ......\n    foreign key (Sno) references S(Sno)#表级定义参照完整性\n    on delete cascade on update cascade,#级联删除、更新\n)\n```\n\n约束语句：\n\n```sql\ncreate table R1(\n    Sno char(20) not null,#非空\n    ...... unique,#列值唯一\n    ......check( ......in(......集合))\n    \n    check (Ssex = 'female'or Sname not like 'Ms.%');\n    \n    \n    #constraint\n    Sno char(20) constraint C1 check(......);#形成一个名为C1的约束条件\n    \n    ......\n    constraint C2 check(......)#在表级定义约束条件\n)\n\nalter table R1 drop constraint C1;#删除约束条件\nalter table R1 create constraint c3 check(......);#创建约束条件，表级。\n```\n\n### 断言\n\n在操作时，使断言不为真的操作拒绝执行。\n\n创建断言：\n\n```sql\ncreate assertion assertion_name check (......);\n\ncreate assertion A1 check(60>=select count(*) from SC where C = 'Cource1');\ncreate assertion A2 check(60>=all(select count(*) from SC group by ...));\n```\n\n### 触发器：\n\n触发器用于在某条件由于操作成立时触发其他操作。\n\n```sql\ncreate trigger trigger_name before/after update on SC\nreferencing new/old row as variable#触发器内设变量：原值和新值\nfor each row / statement#每行触发还是每条语句触发\nwhen(......)#触发条件，比如new.grade>=old.grade\ninsert into Table_name(......) values (......)\n\ndrop trigger trigger_name;#删除（删除对象用drop）\n```\n\n## 规范化\n\n1NF：不可分割\n\n2NF：属性由一码确定\n\n3NF：没有不完全函数依赖，没有传递函数依赖\n\nBCNF：每个决定因素都有码\n\n4NF：不存在非平凡、非函数依赖的多值依赖\n\n规范化的实质：概念的单一化\n\n## 数据库设计\n\n### E-R图\n\n联系：菱形，两侧写是1-1、1-n还是n-1的依赖。\n\n属性：圆形，属性不能有属性（不可再分）\n\n实体：矩形\n\n### 实体描述：\n\n实体{实体的主码（下划线），属性1，属性2，属性3}\n\n## 数据库的故障恢复、数据库的并发控制：\n\n### 事务\n\n事务：一个数据库操作序列，具有ACID特性，即原子性、一致性、隔离性、持续性（永久性）\n\n### 数据库的日志文件\n\n日志文件记录：\n\n事务标识、操作类型、操作对象、操作前值、操作后值。\n\n### 故障处理\n\n事务故障：反向扫描日志文件，撤销已经完成的操作\n\n系统故障：视事务完成情况选择是撤销还是重做，撤销：根据日志写更新前值；重做：根据日志写更新后值。\n\n介质故障：从恢复介质重装数据，然后重做已经完成的事务。\n\n### 并发控制\n\n#### 封锁\n\nX锁（写锁）：上X锁后，其他事务不能读写。\n\nS锁（读锁）：上S锁后，其他事务可以再上S锁，可以读，但是不能写。\n\n##### 封锁协议\n\n一级封锁协议：事务在修改数据前必须加X锁，直至事务结束释放。\n\n二级封锁协议：在一级的基础上，事务读要上S锁，读完释放。\n\n三级封锁协议：在一级的基础上，事务读要上S锁，且事务结束时才释放（解决了不可重复读问题）。\n\n### 活锁与死锁\n\n活锁：事务由于等待其他事务结束无法完成（解决：先来先服务）。\n\n死锁：事务间循环等待导致数个事务不能结束（解决：采取措施避免或每隔一段时间诊断死锁并清除）。\n\n### 意向锁（Intention Lock）\n\nIS锁：对一个对象加IS锁，意味着拟对其后裔结点加S锁。如果要对某个元组加S锁，必须先给关系加IS锁。\n\nIX锁：类似IS锁\n\nSIX锁：对这个对象加S锁，然后加IX锁，代表这个事务希望读这个对象，并可能更新个别元组。\n"},"__N_SSG":true}